generator client {
  provider = "prisma-client-js"
  // Важно для работы и на Windows/Mac (native), и в Docker (linux-musl)
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model plans {
  id             Int       @id @default(autoincrement())
  code           String    @unique @db.VarChar(50)
  name           String    @db.VarChar(100)
  price_monthly  Decimal   @default(0) @db.Decimal(10, 2)
  limit_machines Int       @default(0)
  limit_drivers  Int       @default(0)
  is_active      Boolean   @default(true)
  limit_sites    Int       @default(-1)
  tenants        tenants[]
}

model tenants {
  id               Int           @id @default(autoincrement())
  name             String
  plan_id          Int
  api_key          String?       @unique // Для n8n
  timezone         String        @default("Europe/Moscow")
  invoice_required Boolean       @default(false)
  plan             plans         @relation(fields: [plan_id], references: [id])
  users            users[]
  dict_trucks      dict_trucks[]
  dict_sites       dict_sites[]
  shifts           shifts[]
  invites          invites[]
}

model users {
  id            Int      @id @default(autoincrement())
  tenant_id     Int
  role          String
  full_name     String?
  tg_user_id    BigInt?  @unique
  email         String?  @unique
  password_hash String?
  
  // Машина состояний для Телеграм-бота
  current_state String   @default("idle") 
  
  hourly_rate   Decimal  @default(0) @db.Decimal(12, 2)
  settings      Json?    // Запас на будущее (язык, тема)
  
  tenant        tenants  @relation(fields: [tenant_id], references: [id])
  shifts        shifts[]
}

model dict_trucks {
  id        Int      @id @default(autoincrement())
  tenant_id Int
  name      String
  plate     String?
  code      String?
  is_active Boolean  @default(true)
  is_busy   Boolean  @default(false) // Чтобы не занимали одну машину дважды
  tenant    tenants  @relation(fields: [tenant_id], references: [id])
  shifts    shifts[]
}

model dict_sites {
  id                Int      @id @default(autoincrement())
  tenant_id         Int
  name              String
  address           String?
  code              String?
  odometer_required Boolean  @default(false)
  invoice_required  Boolean  @default(false)
  is_active         Boolean  @default(true)
  tenant            tenants  @relation(fields: [tenant_id], references: [id])
  shifts            shifts[]
}

model shifts {
  id                 Int          @id @default(autoincrement())
  tenant_id          Int
  user_id            Int
  truck_id           Int?
  site_id            Int?
  status             String       // active, finished, pending...
  
  start_time         DateTime?
  end_time           DateTime?
  
  // Финансы
  hours_worked       Decimal      @default(0) @db.Decimal(12, 2)
  salary             Decimal      @default(0) @db.Decimal(12, 2)
  
  // Фотоотчеты
  photo_start_url    String?
  photo_end_url      String?
  photo_invoice_url  String?
  
  // Гео и Пробег (Добавлено!)
  geo_start          Json?        // {lat: 55.7, lon: 37.6}
  geo_end            Json?
  mileage_start      Int?
  mileage_end        Int?
  
  comment            String?
  updated_at         DateTime     @updatedAt
  created_at         DateTime     @default(now()) // Полезно для сортировки

  tenant             tenants      @relation(fields: [tenant_id], references: [id])
  user               users        @relation(fields: [user_id], references: [id])
  truck              dict_trucks? @relation(fields: [truck_id], references: [id])
  site               dict_sites?  @relation(fields: [site_id], references: [id])
}

model invites {
  id         Int      @id @default(autoincrement())
  tenant_id  Int
  code       String   @unique
  expires_at DateTime
  status     String   @default("pending")
  tenant     tenants  @relation(fields: [tenant_id], references: [id])
}
